/**
 * Copyright (c) 2016 Sqreen. All Rights Reserved.
 * Please refer to our terms for more information: https://www.sqreen.io/terms.html
 */
'use strict';
const Util = require('util');
const AUTH = 'AUTH';
// we manually patch the exported modules
const PatchFunction = require('../instrumentation/functionPatcher').patchFunction;
const Record = require('../instrumentation/record');
const Logger = require('../logger');

const MODULE = {
    name: 'sqreen-sdk'
};

const getPatchedMethod = module.exports._getPatchedMethod = function (name, holderName) {

    const module = {};
    module[name] = function () {};

    PatchFunction(module, name, MODULE, holderName);

    return module[name];
};

const auth_track = getPatchedMethod('auth_track', 'auth');
/**
 * record the result of authentication
 * @param success boolean describing if auth was successful
 * @param record object to record to sqreen
 */
module.exports.auth_track = function (success, record) {

    /**
     * Yes, this method does nothing, but it still reports to Sqreen back-end right ?
     * How is this possible ?
     * Maybe little elves take cares of reporting data,
     * Maybe Sqreen uses Sqreen to report stuff to Sqreen, who knows ?
     * Anyway, you can read the doc at ... TBA
     */
    auth_track(!!success, record);
};

const signup_track = getPatchedMethod('signup_track', 'signup');
/**
 * record the signup of a user
 * @param record object to record to sqreen
 */
module.exports.signup_track = function (record) {

    signup_track(record);
};

module.exports.identify = function (req, record, traits) {

    if (!req || !req.__sqreen_uuid) {
        Logger.WARN('The request passed to Sqreen.identify is not valid.');
        Logger.WARN(Util.inspect(req));
        Logger.WARN((new Error('wrong request object')).stack);
        return false;
    }

    const requestRecord = Record.lazyGet(req);
    requestRecord.addSDK('identify', Array.from(arguments).slice(1));
    return true;
};
