/**
 * Copyright (c) 2016 Sqreen. All Rights Reserved.
 * Please refer to our terms for more information: https://www.sqreen.io/terms.html
 */
'use strict';

// needs to run first.

const Code = require('code');
const Lab = require('lab');
const lab = exports.lab = Lab.script();

const describe = lab.describe;
const it = lab.it;
const expect = Code.expect;

const SDK = require('../../lib/sdk');
const Director = require('../../lib/instrumentation/sqreenDirector');

describe('SDK', () => {

    describe('auth', () => {

        describe('_getPatchedMethod', () => {

            it('should return a patchedMethod', { plan: 2 },  (done) => {

                const method = SDK._getPatchedMethod('aaa', 'bbb');

                expect(method).to.be.a.function();
                expect(Director._getInstrumented()['sqreen-sdk']['']['']['bbb:aaa']).to.be.an.array();
                done();
            });
        });

        describe('auth_track', () => {

            it('should trigger the callback on the auth sdk', { plan: 2 }, (done) => {

                Director._getInstrumented()['sqreen-sdk']['']['']['auth:auth_track'][0]({
                    preCbs: [
                        {
                            method: function (args) {

                                expect(args[0]).to.be.true();
                                expect(args[1]).to.equal({ a: 1 });
                                done();
                            }
                        }
                    ]
                });

                SDK.auth_track(true, { a: 1 });
            });

            it('should trigger the callback on the auth sdk', { plan: 2 }, (done) => {

                Director._getInstrumented()['sqreen-sdk']['']['']['auth:auth_track'][0]({
                    preCbs: [
                        {
                            method: function (args) {

                                expect(args[0]).to.be.false();
                                expect(args[1]).to.not.exist();
                                done();
                            }
                        }
                    ]
                });

                SDK.auth_track('');
            });
        });

        describe('signup_track', () => {

            it('should trigger the callback on the auth sdk', { plan: 1 }, (done) => {

                Director._getInstrumented()['sqreen-sdk']['']['']['signup:signup_track'][0]({
                    preCbs: [
                        {
                            method: function (args) {

                                expect(args[0]).to.equal({ a: 1 });
                                done();
                            }
                        }
                    ]
                });

                SDK.signup_track({ a: 1 });
            });
        });

        describe('identify', () => {

            it('should refuse a to operate if there is no proper reques', { plan: 2 }, (done) => {

                expect(SDK.identify(null)).to.be.false();
                expect(SDK.identify({})).to.be.false();
                done();
            });

            it('should create a new record and add auth session', { plan: 10 }, (done) => {

                const Record = require('../../lib/instrumentation/record');
                const res = SDK.identify({ __sqreen_uuid: 10 }, { hello: 'world' }, 'b');
                expect(res).to.be.true();

                expect(Record.lazyGet()).to.not.exist();
                expect(Record.lazyGet({})).to.not.exist();
                const record = Record.STORE.get(10);
                expect(record).to.exist();
                expect(record.sdk).to.have.length(1);
                expect(record.sdk[0].args).to.equal([{ hello: 'world' }, 'b']);
                expect(record.sdk[0].time).to.exist();
                expect(record.sdk[0].name).to.equal('identify');

                SDK.identify({ __sqreen_uuid: 10 }, 'a', 'b', 'c', 'd', 'e');
                expect(record.sdk).to.have.length(2);
                expect(record.sdk[1].args).to.equal(['a', 'b', 'c', 'd', 'e']);
                done();

            });
        });
    });
});
